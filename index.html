
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>QNotes</title>
  <script src="https://alcdn.msauth.net/browser/2.37.0/js/msal-browser.min.js"></script>
  <style>
    body, html {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: sans-serif;
    }
    #login {
      position: absolute;
      top: 10px;
      right: 10px;
      z-index: 10;
    }
    #taskButton {
      display: none;
      position: absolute;
      bottom: 20px;
      right: 20px;
      padding: 10px 20px;
      background-color: #0078d4;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      z-index: 10;
    }
    textarea {
      width: 100%;
      height: 100%;
      padding: 20px;
      box-sizing: border-box;
      font-size: 16px;
      resize: none;
    }
  </style>
</head>
<body>
  <button id="login">Sign In</button>
  <button id="taskButton">Create Task</button>
  <textarea id="notes" placeholder="Start typing your notes..."></textarea>

  <script>
    const msalConfig = {
      auth: {
        clientId: "74ab75f1-811e-4246-a20c-6ef459ecf257",
        redirectUri: "https://jw-ffco.github.io/QNotes/"
      }
    };

    const msalInstance = new msal.PublicClientApplication(msalConfig);
    let accessToken = null;
    let account = null;

    document.getElementById("login").onclick = async () => {
      try {
        const loginResponse = await msalInstance.loginPopup({
          scopes: ["Files.ReadWrite", "Tasks.ReadWrite"]
        });
        account = loginResponse.account;
        const tokenResponse = await msalInstance.acquireTokenSilent({
          scopes: ["Files.ReadWrite", "Tasks.ReadWrite"],
          account: account
        });
        accessToken = tokenResponse.accessToken;
        document.getElementById("login").style.display = "none";
        loadNotes();
      } catch (error) {
        console.error(error);
      }
    };

    async function loadNotes() {
      const response = await fetch("https://graph.microsoft.com/v1.0/me/drive/special/approot:/qnotes.txt", {
        headers: { Authorization: `Bearer ${accessToken}` }
      });
      if (response.ok) {
        const data = await response.json();
        const downloadUrl = data["@microsoft.graph.downloadUrl"];
        const noteText = await fetch(downloadUrl).then(res => res.text());
        document.getElementById("notes").value = noteText;
      }
    }

    async function saveNotes(content) {
      await fetch("https://graph.microsoft.com/v1.0/me/drive/special/approot:/qnotes.txt:/content", {
        method: "PUT",
        headers: {
          Authorization: `Bearer ${accessToken}`,
          "Content-Type": "text/plain"
        },
        body: content
      });
    }

    document.getElementById("notes").addEventListener("input", (e) => {
      if (accessToken) {
        saveNotes(e.target.value);
      }
    });

    document.getElementById("notes").addEventListener("mouseup", () => {
      const selection = window.getSelection().toString();
      document.getElementById("taskButton").style.display = selection ? "block" : "none";
    });

    document.getElementById("taskButton").onclick = async () => {
      const selection = window.getSelection().toString();
      if (!selection || !accessToken) return;

      const now = new Date().toISOString();
      await fetch("https://graph.microsoft.com/v1.0/me/todo/lists/tasks/tasks", {
        method: "POST",
        headers: {
          Authorization: `Bearer ${accessToken}`,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          title: selection,
          dueDateTime: {
            dateTime: now,
            timeZone: "UTC"
          }
        })
      });
      alert("Task created in Microsoft To Do!");
    };
  </script>
</body>
</html>
